<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5º CONCURSO DE VÍDEOS EDUCATIVOS DO SENAR</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/additional-methods.min.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function () {
        // Aplicando máscaras
        $("#cpf").mask("000.000.000-00", { reverse: true });
        $("#cep").mask("00000-000");
        $("#telefone").mask("(00) 00000-0000");

        // Validação do formulário
        $("form").validate({
          rules: {
            cpf: {
              required: true,
              cpfBR: true, // Validador de CPF para Brasil
            },
            telefone: {
              required: true,
              phoneBR: true, // Validador de telefone para Brasil
            },
          },
          messages: {
            cpf: {
              required: "Por favor, insira seu CPF",
              cpfBR: "Por favor, insira um CPF válido",
            },
            telefone: {
              required: "Por favor, insira seu telefone",
              phoneBR: "Por favor, insira um telefone válido",
            },
          },
        });
      });
    </script>
    <div class="container">
      <h1 class="mt-5">Formulário de Cadastro</h1>
      <form action="/" method="POST" enctype="multipart/form-data" class="mt-4">
        <div class="form-group">
          <label for="nome">Nome:</label>
          <input
            type="text"
            class="form-control"
            id="nome"
            name="nome"
            required
          />
        </div>
        <div class="form-group">
          <label for="cpf">CPF:</label>
          <input
            type="text"
            class="form-control"
            id="cpf"
            name="cpf"
            required
          />
        </div>
        <div class="form-group">
          <label for="endereco">Endereço:</label>
          <input
            type="text"
            class="form-control"
            id="endereco"
            name="endereco"
            required
          />
        </div>
        <div class="form-group">
          <label for="cep">CEP:</label>
          <input
            type="text"
            class="form-control"
            id="cep"
            name="cep"
            required
          />
        </div>
        <div class="form-group">
          <label for="estado">Estado:</label>
          <input
            type="text"
            class="form-control"
            id="estado"
            name="estado"
            required
          />
        </div>
        <div class="form-group">
          <label for="telefone">Telefone:</label>
          <input
            type="text"
            class="form-control"
            id="telefone"
            name="telefone"
            required
          />
        </div>
        <div class="form-group">
          <label for="tema">Tema:</label>
          <input
            type="text"
            class="form-control"
            id="tema"
            name="tema"
            required
          />
        </div>
        <div class="form-group">
          <label for="referencia_video">Referência de Vídeo:</label>
          <select
            class="form-control"
            id="referencia_video"
            name="referencia_video"
          >
            <option value="Formação Profissional Rural">
              Formação Profissional Rural
            </option>
            <option value="Promoção Social">Promoção Social</option>
            <option value="Assistência Técnica e Gerencial">
              Assistência Técnica e Gerencial
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="formacao">Formação:</label>
          <select class="form-control" id="formacao" name="formacao">
            <option value="Sistema de Produção Agropecuário">
              Sistema de Produção Agropecuário
            </option>
            <option value="Bem-estar Animal: as 5 liberdades dos animais">
              Bem-estar Animal: as 5 liberdades dos animais
            </option>
            <option value="Meio Ambiente">Meio Ambiente</option>
            <option value="Gestão Rural">Gestão Rural</option>
          </select>
        </div>
        <div class="form-group">
          <label for="promocao">Promoção:</label>
          <select class="form-control" id="promocao" name="promocao">
            <option value="Alimentação e Nutrição">
              Alimentação e Nutrição
            </option>
            <option value="Inclusão Digital">Inclusão Digital</option>
            <option value="Organização Comunitária">
              Organização Comunitária
            </option>
            <option value="Saúde Preventiva">Saúde Preventiva</option>
          </select>
        </div>
        <div class="form-group">
          <label for="assistencia">Assistência:</label>
          <select class="form-control" id="assistencia" name="assistencia">
            <option value="Aumento da Produção Custos">
              Aumento da Produção Custos
            </option>
            <option value="Geração de renda e redução de">
              Geração de renda e redução de
            </option>
            <option value="Produzindo alimento com respeito ao meio ambiente">
              Produzindo alimento com respeito ao meio ambiente
            </option>
            <option value="Qualidade de Vida">Qualidade de Vida</option>
          </select>
        </div>
        <div class="form-group">
          <label for="videoUpload">Upload de Vídeo:</label>
          <input
            type="file"
            class="form-control-file"
            id="videoUpload"
            name="videoUpload"
            accept="video/*"
            required
          />
          <progress
            id="uploadProgress"
            value="0"
            max="100"
            style="width: 100%"
          ></progress>
        </div>
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="privacyPolicy"
            name="privacyPolicy"
            required
          />
          <label class="form-check-label" for="privacyPolicy"
            >Eu aceito a política de privacidade</label
          >
        </div>

        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const referenciaVideo = document.getElementById("referencia_video");
        const formacao = document
          .getElementById("formacao")
          .closest(".form-group");
        const promocao = document
          .getElementById("promocao")
          .closest(".form-group");
        const assistencia = document
          .getElementById("assistencia")
          .closest(".form-group");

        function hideAll() {
          formacao.style.display = "none";
          promocao.style.display = "none";
          assistencia.style.display = "none";
        }

        function showField() {
          const value = referenciaVideo.value;
          hideAll();
          if (value === "Formação Profissional Rural") {
            formacao.style.display = "block";
          } else if (value === "Promoção Social") {
            promocao.style.display = "block";
          } else if (value === "Assistência Técnica e Gerencial") {
            assistencia.style.display = "block";
          }
        }

        hideAll();

        referenciaVideo.addEventListener("change", showField);
      });
      document
        .getElementById("videoUpload")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onloadstart = function (e) {
            document.getElementById("uploadProgress").value = 0;
          };
          reader.onprogress = function (e) {
            if (e.lengthComputable) {
              const percentComplete = parseInt((e.loaded / e.total) * 100);
              document.getElementById("uploadProgress").value = percentComplete;
            }
          };
          reader.onloadend = function (e) {
            document.getElementById("uploadProgress").value = 100;
          };
          reader.readAsDataURL(file);
        });
      document.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault();
        var form = this;
        var formData = new FormData(form);

        Swal.fire({
          title: "Enviando...",
          text: "Por favor, aguarde enquanto o vídeo está sendo enviado.",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        fetch("/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json()) // Assegure-se de sempre processar a resposta como JSON.
          .then((data) => {
            Swal.close();
            if (data.message === "Vídeo registrado com sucesso!") {
              Swal.fire(
                "Sucesso!",
                "Seu vídeo foi enviado com sucesso!",
                "success"
              ).then((result) => {
                if (result.isConfirmed) {
                  form.reset();
                }
              });
            } else {
              Swal.fire(
                "Erro!",
                data.error ||
                  "Houve um erro ao enviar o vídeo. Tente novamente!",
                "error"
              );
            }
          })
          .catch((error) => {
            Swal.close();
            console.error("Error:", error);
            Swal.fire(
              "Erro!",
              "Houve um problema com a rede ou o servidor. Tente novamente!",
              "error"
            );
          });
      });
    </script>
  </body>
</html>
